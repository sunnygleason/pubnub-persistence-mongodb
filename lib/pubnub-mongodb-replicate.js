// Generated by CoffeeScript 1.7.1
(function() {
  var CHANNEL, MONGO_ADDR, MONGO_COLL, MONGO_HOST, MONGO_PORT, MongoWatch, PUBNUB, asString, pubnub, watcher, _;

  PUBNUB = require('../deps/pubnub-javascript/node.js/pubnub.js');

  _ = require('../deps/underscore/underscore.js');

  MongoWatch = require('../deps/mongo-watch/index.js');

  asString = function(e) {
    return _.map(e, function(x) {
      return x.toString();
    });
  };

  pubnub = PUBNUB.init({
    subscribe_key: 'demo',
    publish_key: 'demo'
  });

  MONGO_ADDR = (process.argv[2] || 'localhost:27017').split(":");

  MONGO_HOST = MONGO_ADDR[0];

  MONGO_PORT = MONGO_ADDR[1];

  MONGO_COLL = process.argv[3];

  CHANNEL = process.argv[4];

  watcher = new MongoWatch({
    format: 'pretty'
  });

  watcher.watch(MONGO_COLL, function(entry) {
    console.log("- got event : " + JSON.stringify(entry));
    return pubnub.publish({
      channel: CHANNEL,
      message: {
        type: 'oplog',
        uuid: pubnub.uuid(),
        entry: entry
      }
    });
  });

  console.log("Replicating from MongoDB host " + MONGO_ADDR + " collection " + MONGO_COLL + " to PubNub channel \#" + CHANNEL);

}).call(this);
